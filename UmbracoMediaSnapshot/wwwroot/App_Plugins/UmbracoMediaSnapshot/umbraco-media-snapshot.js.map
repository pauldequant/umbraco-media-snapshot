{"version":3,"file":"umbraco-media-snapshot.js","sources":["../../../Client/src/snapshot-viewer.ts"],"sourcesContent":["import { LitElement, html, css, customElement, state } from '@umbraco-cms/backoffice/external/lit';\r\nimport { UmbElementMixin } from '@umbraco-cms/backoffice/element-api';\r\nimport { UMB_WORKSPACE_CONTEXT } from '@umbraco-cms/backoffice/workspace';\r\nimport { UMB_AUTH_CONTEXT } from '@umbraco-cms/backoffice/auth'; // Import Auth Context\r\nimport type { UmbEntityWorkspaceContext } from '@umbraco-cms/backoffice/workspace';\r\n\r\n/**\r\n * Snapshot Viewer Property Editor\r\n * Displays a list of file versions from the umbraco-snapshots Azure container\r\n */\r\n@customElement('snapshot-viewer')\r\nexport class SnapshotViewerElement extends UmbElementMixin(LitElement) {\r\n\r\n    @state()\r\n    private _versions: any[] = [];\r\n\r\n    @state()\r\n    private _loading = true;\r\n\r\n    @state()\r\n    private _mediaKey = '';\r\n\r\n    private _authContext?: typeof UMB_AUTH_CONTEXT.TYPE;\r\n\r\n    constructor() {\r\n        super();\r\n\r\n        // 1. Consume the Auth Context to manage tokens\r\n        this.consumeContext(UMB_AUTH_CONTEXT, (instance) => {\r\n            this._authContext = instance;\r\n        });\r\n\r\n        this.consumeContext(UMB_WORKSPACE_CONTEXT, (workspaceContext) => {\r\n            const entityWorkspace = workspaceContext as unknown as UmbEntityWorkspaceContext;\r\n            if (entityWorkspace.unique) {\r\n                this.observe(entityWorkspace.unique, (unique) => {\r\n                    if (unique && unique !== this._mediaKey) {\r\n                        this._mediaKey = unique.toString();\r\n                        this._fetchVersions(this._mediaKey);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Calls the C# Management API to get the list of blobs\r\n     * Umbraco 17 automatically injects Auth Bearer tokens into fetch \r\n     * requests starting with /umbraco/management/api/\r\n     */\r\n    private async _fetchVersions(mediaKey: string) {\r\n        this._loading = true;\r\n\r\n        // 2. Get the latest token from the auth context\r\n        const token = await this._authContext?.getLatestToken();\r\n\r\n        if (!token) {\r\n            console.error(\"No authentication token available.\");\r\n            this._loading = false;\r\n            return;\r\n        }\r\n\r\n        try {\r\n            const url = `/umbraco/management/api/v1/snapshot/versions/${mediaKey}`;\r\n\r\n            // 3. Manually add the Authorization header\r\n            const response = await fetch(url, {\r\n                method: 'GET',\r\n                headers: {\r\n                    'Authorization': `Bearer ${token}`,\r\n                    'Content-Type': 'application/json'\r\n                }\r\n            });\r\n\r\n            if (response.ok) {\r\n                this._versions = await response.json();\r\n            } else if (response.status === 401) {\r\n                console.error(\"Unauthorized: The session may have expired.\");\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Failed to fetch snapshots:\", error);\r\n        } finally {\r\n            this._loading = false;\r\n        }\r\n    }\r\n\r\n    render() {\r\n        if (this._loading) {\r\n            return html`<div class=\"loader\"><uui-loader></uui-loader> Fetching snapshots...</div>`;\r\n        }\r\n\r\n        if (this._versions.length === 0) {\r\n            return html`\r\n                <uui-box>\r\n                    <uui-tag look=\"placeholder\">No previous versions found in the snapshots container.</uui-tag>\r\n                </uui-box>\r\n            `;\r\n        }\r\n\r\n        return html`\r\n                <uui-table>\r\n                    <uui-table-head>\r\n                        <uui-table-head-cell>Version Filename</uui-table-head-cell>\r\n                        <uui-table-head-cell>Date Uploaded</uui-table-head-cell>\r\n                        <uui-table-cell>Uploaded By</uui-table-cell>\r\n                        <uui-table-head-cell>Action</uui-table-head-cell>\r\n                    </uui-table-head>\r\n\r\n                    ${this._versions.map(v => html`\r\n                        <uui-table-row>\r\n                            <uui-table-cell>${v.name}</uui-table-cell>\r\n                            <uui-table-cell>${this._formatDate(v.date)}</uui-table-cell>\r\n                            <uui-table-cell>${v.uploader.replace(/_/g, ' ')}</uui-table-cell>\r\n                            <uui-table-cell>\r\n                                <uui-button \r\n                                    look=\"secondary\" \r\n                                    compact \r\n                                    href=\"${v.url}\" \r\n                                    target=\"_blank\">\r\n                                    <uui-icon name=\"download\"></uui-icon> Download\r\n                                </uui-button>\r\n                            </uui-table-cell>\r\n                        </uui-table-row>\r\n                    `)}\r\n                </uui-table>\r\n        `;\r\n    }\r\n\r\n    private _formatDate(dateString: string) {\r\n        const date = new Date(dateString);\r\n        return date.toLocaleDateString(undefined, {\r\n            day: '2-digit',\r\n            month: 'short',\r\n            year: 'numeric',\r\n            hour: '2-digit',\r\n            minute: '2-digit'\r\n        });\r\n    }\r\n\r\n    static styles = css`\r\n        :host {\r\n            display: block;\r\n            margin-bottom: 20px;\r\n        }\r\n        \r\n        .loader {\r\n            display: flex;\r\n            align-items: center;\r\n            gap: 10px;\r\n            padding: 20px;\r\n            color: var(--uui-color-text-alt);\r\n        }\r\n\r\n        uui-table {\r\n            border: 1px solid var(--uui-color-border);\r\n            border-radius: var(--uui-border-radius);\r\n            background: var(--uui-color-surface);\r\n        }\r\n\r\n        uui-table-head-cell {\r\n            font-weight: bold;\r\n        }\r\n\r\n        uui-icon {\r\n            margin-right: 4px;\r\n        }\r\n    `;\r\n}\r\n\r\n// Global declaration for TS intellisense\r\ndeclare global {\r\n    interface HTMLElementTagNameMap {\r\n        'snapshot-viewer': SnapshotViewerElement;\r\n    }\r\n}"],"names":["SnapshotViewerElement","UmbElementMixin","LitElement","UMB_AUTH_CONTEXT","instance","UMB_WORKSPACE_CONTEXT","workspaceContext","entityWorkspace","unique","mediaKey","token","url","response","error","html","v","dateString","css","__decorateClass","state","customElement"],"mappings":";;;;;;;;;AAWO,IAAMA,IAAN,cAAoCC,EAAgBC,CAAU,EAAE;AAAA,EAanE,cAAc;AACV,UAAA,GAXJ,KAAQ,YAAmB,CAAA,GAG3B,KAAQ,WAAW,IAGnB,KAAQ,YAAY,IAQhB,KAAK,eAAeC,GAAkB,CAACC,MAAa;AAChD,WAAK,eAAeA;AAAA,IACxB,CAAC,GAED,KAAK,eAAeC,GAAuB,CAACC,MAAqB;AAC7D,YAAMC,IAAkBD;AACxB,MAAIC,EAAgB,UAChB,KAAK,QAAQA,EAAgB,QAAQ,CAACC,MAAW;AAC7C,QAAIA,KAAUA,MAAW,KAAK,cAC1B,KAAK,YAAYA,EAAO,SAAA,GACxB,KAAK,eAAe,KAAK,SAAS;AAAA,MAE1C,CAAC;AAAA,IAET,CAAC;AAAA,EACL;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,MAAc,eAAeC,GAAkB;AAC3C,SAAK,WAAW;AAGhB,UAAMC,IAAQ,MAAM,KAAK,cAAc,eAAA;AAEvC,QAAI,CAACA,GAAO;AACR,cAAQ,MAAM,oCAAoC,GAClD,KAAK,WAAW;AAChB;AAAA,IACJ;AAEA,QAAI;AACA,YAAMC,IAAM,gDAAgDF,CAAQ,IAG9DG,IAAW,MAAM,MAAMD,GAAK;AAAA,QAC9B,QAAQ;AAAA,QACR,SAAS;AAAA,UACL,eAAiB,UAAUD,CAAK;AAAA,UAChC,gBAAgB;AAAA,QAAA;AAAA,MACpB,CACH;AAED,MAAIE,EAAS,KACT,KAAK,YAAY,MAAMA,EAAS,KAAA,IACzBA,EAAS,WAAW,OAC3B,QAAQ,MAAM,6CAA6C;AAAA,IAEnE,SAASC,GAAO;AACZ,cAAQ,MAAM,8BAA8BA,CAAK;AAAA,IACrD,UAAA;AACI,WAAK,WAAW;AAAA,IACpB;AAAA,EACJ;AAAA,EAEA,SAAS;AACL,WAAI,KAAK,WACEC,+EAGP,KAAK,UAAU,WAAW,IACnBA;AAAA;AAAA;AAAA;AAAA,gBAOJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,sBASO,KAAK,UAAU,IAAI,CAAAC,MAAKD;AAAA;AAAA,8CAEAC,EAAE,IAAI;AAAA,8CACN,KAAK,YAAYA,EAAE,IAAI,CAAC;AAAA,8CACxBA,EAAE,SAAS,QAAQ,MAAM,GAAG,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA,4CAK/BA,EAAE,GAAG;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qBAM5B,CAAC;AAAA;AAAA;AAAA,EAGlB;AAAA,EAEQ,YAAYC,GAAoB;AAEpC,WADa,IAAI,KAAKA,CAAU,EACpB,mBAAmB,QAAW;AAAA,MACtC,KAAK;AAAA,MACL,OAAO;AAAA,MACP,MAAM;AAAA,MACN,MAAM;AAAA,MACN,QAAQ;AAAA,IAAA,CACX;AAAA,EACL;AA8BJ;AA5JahB,EAgIF,SAASiB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AA7HRC,EAAA;AAAA,EADPC,EAAA;AAAM,GAFEnB,EAGD,WAAA,aAAA,CAAA;AAGAkB,EAAA;AAAA,EADPC,EAAA;AAAM,GALEnB,EAMD,WAAA,YAAA,CAAA;AAGAkB,EAAA;AAAA,EADPC,EAAA;AAAM,GAREnB,EASD,WAAA,aAAA,CAAA;AATCA,IAANkB,EAAA;AAAA,EADNE,EAAc,iBAAiB;AAAA,GACnBpB,CAAA;"}